WITH SQ_S10_NJ_DMV_EXTRACT_temp AS (
    SELECT 
        ROW_NUMBER() OVER (ORDER BY TPDH.POL_PK) AS source_record_id, -- TPDH refers to T_POL_DIM_HST
        TPAH.STATE,
        TPAH.CNTY,
        TPAH.PSTL_CD,
        TPDH.PRE_CONV_CO_CD,
        TPAH.ADDR_PK,
        TPAH.PMRY_ADDR_FLG,
        TPAH.HSE_NUM,
        TPDH.POL_PK, -- Table alias for POL_PK in T_POL_DIM_HST
        TPDH.POL_NUM,
        TPDH.POL_SEQ_NUM,
        TPDH.LAPSE_BEGIN_DT,
        TPDH.LAPSE_END_DT,
        TPDH.DATA_DT,
        TPDH.PROD_CD,
        TPDH.PLN_CD,
        TPDH.CNCL_TYP,
        TPDH.POL_VRSN_TXN_TYP,
        TPDH.ROW_STAT,
        TPDH.CUR_TERM_EFF_DT,
        TPDH.CUR_TERM_XPTN_DT,
        TPDH.CNCL_RSN,
        TPDH.RCD_ACTN_TYP,
        TPFDH.PRIME_CONV_FLG,
        TPFDH.PRIME_POL_FLG,
        TPCTH.VEH_CT,
        TPDH.PRCSG_GRP_CD,
        TPDH.POL_STATE_STAT,
        TPDH.SRC_POL_ID,
        TPDH.CO_ID,
        TPDH.PROD_ID,
        TPDH.POL_STATE_VRSN,
        TPDH.POL_STATE_EFF_DT,
        TPDH.ROW_XPTN_DT,
        TPDH.CORP_CD,
        TPDH.CO_CD,
        TPDH.SRC_PROD_ID,
        TPDH.SRC_CD,
        TPDH.CNCL_EFF_DT,
        TPDH.REINST_EFF_DT,
        TPDH.ACCTG_DT,
        TPDH.REINST_TYP,
        TPPDH.DRVR_LIC_NUM,
        TPPDH.DRVR_LIC_STATE,
        TPPDH.INSD_PTY_PK,
        TPPDH.SRC_PTY_ID,
        TPPDH.NAM_FST,
        TPPDH.NAM_LST,
        TPPDH.NAM_MDL,
        TPPDH.NAM_SFX,
        TPPDH.BUS_NAM,
        TPPDH.PMRY_NAMD_INSD_FLG,
        TPPDH.NAMD_INSD_FLG,
        TPPDH.DRVR_FLG,
        TPVUDH.STAT_MAKE_CD,
        TPVUDH.MODEL_YR,
        TPVUDH.MK,
        TPVUDH.VEH_UNIT_PK,
        TPVUDH.RCD_ACTN_TYP AS RCD_ACTN_TYP_veh,
        TPVUDH.ORGL_EFF_DT,
        TPVUDH.VEH_TYP_CD,
        TPVUDH.VIN,
        TCD.SRC_CORP_ID,
        TCD.SRC_CO_ID,
        TPAH.ADDRESS1,
        TPAH.ADDRESS2,
        TPAH.ADDRESS3,
        TPAH.ADDRESS4,
        TPAH.CITY
    FROM 
        CDWQA.DWADMN.T_POL_ADDR_DIM_HST TPAH, -- Alias TPAH for T_POL_ADDR_DIM_HST
        CDWQA.DWADMN.T_POL_PTY_DIM_HST TPPDH, -- Alias TPPDH for T_POL_PTY_DIM_HST
        CDWQA.DWADMN.T_POL_FLG_DIM_HST TPFDH, -- Alias TPFDH for T_POL_FLG_DIM_HST
        CDWQA.DWADMN.T_POL_CT_DIM_HST TPCTH, -- Alias TPCTH for T_POL_CT_DIM_HST
        CDWQA.DWADMN.T_POL_VEH_UNIT_DIM_HST TPVUDH, -- Alias TPVUDH for T_POL_VEH_UNIT_DIM_HST
        CDWQA.DWADMN.T_POL_DIM_HST TPDH, -- Alias TPDH for T_POL_DIM_HST
        CDWQA.DWADMN.T_CO_DIM TCD -- Alias TCD for T_CO_DIM
    WHERE 
        TPAH.POL_PK = TPDH.POL_PK  -- Use table alias TPAH for T_POL_ADDR_DIM_HST
        AND TPPDH.POL_PK = TPDH.POL_PK  -- Use table alias TPPDH for T_POL_PTY_DIM_HST
        AND TPFDH.POL_PK = TPDH.POL_PK  -- Use table alias TPFDH for T_POL_FLG_DIM_HST
        AND TPCTH.POL_PK = TPDH.POL_PK  -- Use table alias TPCTH for T_POL_CT_DIM_HST
        AND TPVUDH.POL_PK = TPDH.POL_PK  -- Use table alias TPVUDH for T_POL_VEH_UNIT_DIM_HST
        AND TPDH.CO_ID = TCD.CO_ID  -- Use table alias TPDH for T_POL_DIM_HST
        AND RTRIM(TPDH.PRCSG_GRP_CD) IN ('HP', 'PL')
        AND RTRIM(TPDH.STATE_CD) = 'NJ'
        AND RTRIM(TPDH.CO_CD) IN ('HPPREF', 'HPPROP', 'HPPROP2', 'HPSIC', 'PAIPTWIN', 'PIC', 'PSIA', 'TCTIPU', 'TCTIPU2', 'ALN_HPCIC', 'ALN_TEACH', 'ALN_PSIA', 'ALN_PIC')
        AND RTRIM(TPDH.CORP_CD) IN ('HIGHPOINT', 'Palisades')
        AND (
            (RTRIM(TPDH.PROD_CD) IN ('PA', 'PAIP'))
            OR (RTRIM(TPDH.PROD_CD) = 'PIC_NEW_CA' AND TPDH.LEG_ENT_CD = 'A')
            OR (RTRIM(TPDH.PROD_CD) = 'PIC_NEW_CA' AND LTRIM(RTRIM(TPVUDH.VEH_TYP_CD)) = 'LMO' AND TPCTH.VEH_CT <= 5)
        )
        AND TPDH.RCD_ACTN_TYP <> 'D'
        AND (
            (TPDH.ACCTG_DT <= '{{BATCH_END_DT}}' AND TPDH.POL_STATE_EFF_DT <= '{{RPRTG_PERIOD_END_DT}}' AND TPDH.POL_STATE_EFF_DT >= '{{RPRTG_PERIOD_START_DT}}')
            OR (TPDH.ACCTG_DT <= '{{BATCH_END_DT}}' AND TPDH.ACCTG_DT >= '{{BATCH_START_DT}}' AND TPDH.POL_STATE_EFF_DT < '{{RPRTG_PERIOD_START_DT}}')
        )
        AND (
            (TPDH.POL_VRSN_TXN_TYP = 'NB' AND (TPDH.CONV_POL = 'N' OR TPDH.CONV_POL IS NULL))
            OR (TPFDH.PRIME_CONV_FLG = 'Y' AND TPDH.CO_CD = 'ALN_PIC' AND TPDH.POL_VRSN_TXN_TYP = 'RN')
            OR (TPFDH.PRIME_CONV_FLG = 'Y' AND TPDH.CO_CD = 'ALN_PSIA' AND TPDH.POL_VRSN_TXN_TYP = 'RN' AND TPDH.PRE_CONV_CO_CD = 'PIC')
            OR (TPDH.POL_VRSN_TXN_TYP = 'RN' AND TPDH.ICT_DT = TPDH.CUR_TERM_EFF_DT AND





















WITH SQ_S10_NJ_DMV_EXTRACT_temp as (
        SELECT row_number() over(order by POL_PK) AS source_record_id,
               T_POL_ADDR_DIM_HST.STATE,
               T_POL_ADDR_DIM_HST.CNTY,
               T_POL_ADDR_DIM_HST.PSTL_CD,
               T_POL_DIM_HST.PRE_CONV_CO_CD,
               T_POL_ADDR_DIM_HST.ADDR_PK,
               T_POL_ADDR_DIM_HST.PMRY_ADDR_FLG,
               T_POL_ADDR_DIM_HST.HSE_NUM,
               T_POL_DIM_HST.POL_PK,
               T_POL_DIM_HST.POL_NUM,
               T_POL_DIM_HST.POL_SEQ_NUM,
               T_POL_DIM_HST.LAPSE_BEGIN_DT,
               T_POL_DIM_HST.LAPSE_END_DT,
               T_POL_DIM_HST.DATA_DT,
               T_POL_DIM_HST.PROD_CD,
               T_POL_DIM_HST.PLN_CD,
               T_POL_DIM_HST.CNCL_TYP,
               T_POL_DIM_HST.POL_VRSN_TXN_TYP,
               T_POL_DIM_HST.ROW_STAT,
               T_POL_DIM_HST.CUR_TERM_EFF_DT,
               T_POL_DIM_HST.CUR_TERM_XPTN_DT,
               T_POL_DIM_HST.CNCL_RSN,
               T_POL_DIM_HST.RCD_ACTN_TYP,
               T_POL_FLG_DIM_HST.PRIME_CONV_FLG,
               T_POL_FLG_DIM_HST.PRIME_POL_FLG,
               T_POL_CT_DIM_HST.VEH_CT,
               T_POL_DIM_HST.PRCSG_GRP_CD,
               T_POL_DIM_HST.POL_STATE_STAT,
               T_POL_DIM_HST.SRC_POL_ID,
               T_POL_DIM_HST.CO_ID,
               T_POL_DIM_HST.PROD_ID,
               T_POL_DIM_HST.POL_STATE_VRSN,
               T_POL_DIM_HST.POL_STATE_EFF_DT,
               T_POL_DIM_HST.ROW_XPTN_DT,
               T_POL_DIM_HST.CORP_CD,
               T_POL_DIM_HST.CO_CD,
               T_POL_DIM_HST.SRC_PROD_ID,
               T_POL_DIM_HST.SRC_CD,
               T_POL_DIM_HST.CNCL_EFF_DT,
               T_POL_DIM_HST.REINST_EFF_DT,
               T_POL_DIM_HST.ACCTG_DT,
               T_POL_DIM_HST.REINST_TYP,
               T_POL_PTY_DIM_HST.DRVR_LIC_NUM,
               T_POL_PTY_DIM_HST.DRVR_LIC_STATE,
               T_POL_PTY_DIM_HST.INSD_PTY_PK,
               T_POL_PTY_DIM_HST.SRC_PTY_ID,
               T_POL_PTY_DIM_HST.NAM_FST,
               T_POL_PTY_DIM_HST.NAM_LST,
               T_POL_PTY_DIM_HST.NAM_MDL,
               T_POL_PTY_DIM_HST.NAM_SFX,
               T_POL_PTY_DIM_HST.BUS_NAM,
               T_POL_PTY_DIM_HST.PMRY_NAMD_INSD_FLG,
               T_POL_PTY_DIM_HST.NAMD_INSD_FLG,
               T_POL_PTY_DIM_HST.DRVR_FLG,
               T_POL_VEH_UNIT_DIM_HST.STAT_MAKE_CD,
               T_POL_VEH_UNIT_DIM_HST.MODEL_YR,
               T_POL_VEH_UNIT_DIM_HST.MK,
               T_POL_VEH_UNIT_DIM_HST.VEH_UNIT_PK,
               T_POL_VEH_UNIT_DIM_HST.RCD_ACTN_TYP AS RCD_ACTN_TYP_veh,
               T_POL_VEH_UNIT_DIM_HST.ORGL_EFF_DT,
               T_POL_VEH_UNIT_DIM_HST.VEH_TYP_CD,
               T_POL_VEH_UNIT_DIM_HST.VIN,
               T_CO_DIM.SRC_CORP_ID,
               T_CO_DIM.SRC_CO_ID,
               T_POL_ADDR_DIM_HST.ADDRESS1,
               T_POL_ADDR_DIM_HST.ADDRESS2,
               T_POL_ADDR_DIM_HST.ADDRESS3,
               T_POL_ADDR_DIM_HST.ADDRESS4,
               T_POL_ADDR_DIM_HST.CITY
          FROM CDWQA.DWADMN.T_POL_ADDR_DIM_HST,
               CDWQA.DWADMN.T_POL_PTY_DIM_HST,
               CDWQA.DWADMN.T_POL_FLG_DIM_HST,
               CDWQA.DWADMN.T_POL_CT_DIM_HST,
               CDWQA.DWADMN.T_POL_VEH_UNIT_DIM_HST,
               CDWQA.DWADMN.T_POL_DIM_HST,
               CDWQA.DWADMN.T_CO_DIM
         WHERE T_POL_ADDR_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK
           AND T_POL_PTY_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK
           AND T_POL_FLG_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK
           AND T_POL_CT_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK
           AND T_POL_VEH_UNIT_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK
           AND T_POL_DIM_HST.CO_ID=T_CO_DIM.CO_ID
		   and RTRIM(T_Pol_Dim_Hst.PRCSG_GRP_CD) IN ('HP', 'PL')
           and RTRIM(T_POL_DIM_HST.STATE_CD)='NJ'
           and RTRIM(T_Pol_Dim_Hst.CO_CD) IN ('HPPREF', 'HPPROP', 'HPPROP2', 'HPSIC', 'PAIPTWIN', 'PIC', 'PSIA', 'TCTIPU', 'TCTIPU2', 'ALN_HPCIC', 'ALN_TEACH', 'ALN_PSIA','ALN_PIC')
           and RTRIM(T_Pol_Dim_Hst.CORP_CD) IN ('HIGHPOINT', 'Palisades')
           AND ((RTRIM(T_Pol_Dim_Hst.PROD_CD) IN ('PA', 'PAIP')) OR (RTRIM(T_Pol_Dim_Hst.PROD_CD) = 'PIC_NEW_CA' and T_Pol_Dim_Hst.LEG_ENT_CD = 'A') OR (RTRIM(T_Pol_Dim_Hst.PROD_CD) = 'PIC_NEW_CA' and LTRIM(RTRIM(T_POL_VEH_UNIT_DIM_HST.VEH_TYP_CD)) = 'LMO' AND T_POL_CT_DIM_HST.VEH_CT <= 5))
           and T_Pol_Dim_Hst.RCD_ACTN_TYP <> 'D'
           and ((T_POL_DIM_HST.ACCTG_DT <= '{{BATCH_END_DT}}'
AND
T_POL_DIM_HST.POL_STATE_EFF_DT <= '{{RPRTG_PERIOD_END_DT}}' AND T_POL_DIM_HST.POL_STATE_EFF_DT >= '{{RPRTG_PERIOD_START_DT}}')
OR
(T_POL_DIM_HST.ACCTG_DT <= '{{BATCH_END_DT}}' AND T_POL_DIM_HST.ACCTG_DT >= '{{BATCH_START_DT}}'
AND
T_POL_DIM_HST.POL_STATE_EFF_DT < '{{RPRTG_PERIOD_START_DT}}'))
           and ((T_Pol_Dim_Hst.Pol_Vrsn_Txn_Typ = 'NB' and (T_Pol_Dim_Hst.conv_pol = 'N' or T_Pol_Dim_Hst.conv_pol is null)) or (T_POL_FLG_DIM_HST.PRIME_CONV_FLG = 'Y' and T_Pol_Dim_Hst.CO_CD = 'ALN_PIC' and T_POL_DIM_HST.POL_VRSN_TXN_TYP = 'RN') or (T_POL_FLG_DIM_HST.PRIME_CONV_FLG = 'Y' and T_Pol_Dim_Hst.CO_CD = 'ALN_PSIA' and T_POL_DIM_HST.POL_VRSN_TXN_TYP = 'RN' and T_POL_DIM_HST. PRE_CONV_CO_CD = 'PIC') or (T_Pol_Dim_Hst.Pol_Vrsn_Txn_Typ = 'RN' and T_Pol_Dim_Hst.ict_dt = T_Pol_Dim_Hst.cur_term_eff_dt and T_POL_CT_DIM_HST.ict_ct = 1) or (SUBSTR(T_POL_DIM_HST.POL_VRSN_TXN_TYP,1,2) = 'EN' and T_POL_VEH_UNIT_DIM_HST.RCD_ACTN_TYP = 'A' and T_POL_DIM_HST.POL_STATE_EFF_DT >= T_POL_DIM_HST.CUR_TERM_EFF_DT) or (RTRIM(LTRIM(T_POL_DIM_HST.POL_VRSN_TXN_TYP)) IN ('CN', 'CNX') AND RTRIM(LTRIM(T_POL_DIM_HST.CNCL_RSN)) IN ('NONPAY','NP','NP_CR','NP_PF')) or (SUBSTR(T_POL_DIM_HST.POL_VRSN_TXN_TYP,1,2) = 'RS' AND RTRIM(LTRIM(T_POL_DIM_HST.REINST_TYP)) = 'WITH LAPSE' AND RTRIM(LTRIM(T_POL_DIM_HST.CNCL_RSN)) IN ('NONPAY','NP','NP_CR','NP_PF')) OR (SUBSTR(T_POL_DIM_HST.POL_VRSN_TXN_TYP,1,2) = 'RS' AND RTRIM(LTRIM(T_POL_DIM_HST.REINST_TYP)) = 'REINSTATE' AND RTRIM(LTRIM(T_POL_DIM_HST.CNCL_RSN)) IN ('NONPAY','NP','NP_CR','NP_PF') AND T_POL_DIM_HST.ROW_STAT = 'C'))
           AND T_Pol_Veh_Unit_Dim_Hst.Veh_Typ_Cd IN ('AQ', 'CL', 'CV', 'PP', 'PPA', 'PPP','LMO','VAN')
           AND T_Pol_Pty_Dim_Hst.Pmry_Namd_Insd_Flg='Y'
           AND T_Pol_Addr_Dim_Hst.Pmry_Addr_Flg='Y'
           AND (T_POL_FLG_DIM_HST.MOTORCYCLE_POL_FLG != 'Y' OR T_POL_FLG_DIM_HST.MOTORCYCLE_POL_FLG IS NULL)
           AND NOT EXISTS (
                SELECT *
                  from RRM.T_ESS_SMOKETEST_POLICIES
                 where T_ESS_SMOKETEST_POLICIES.STATE_CD=T_POL_DIM_HST.STATE_CD
                   and T_ESS_SMOKETEST_POLICIES.POL_NUM=T_POL_DIM_HST.POL_NUM
               )
       ) 
       select * from SQ_S10_NJ_DMV_EXTRACT_TEMP
     
