WITH EXP_NJ_DMV_MTHLY_MERGE_DATA AS (
    -- Adding OUT_DMV_TRANSACTION_TYPE_CODE in this CTE
    SELECT 
        JNR_HEADER_DETAIL.DMV_VIN,
        JNR_HEADER_DETAIL.DMV_DRIVER_LICENSE_NUMBER,
        JNR_HEADER_DETAIL.DMV_MAKE_OF_CAR,
        JNR_HEADER_DETAIL.DMV_YEAR_OF_CAR,
        JNR_HEADER_DETAIL.DMV_MODEL_OF_CAR,
        JNR_HEADER_DETAIL.DMV_INS_COMPANY_CD,
        JNR_HEADER_DETAIL.DMV_POLICY_OWNER_STREET_ADDR,
        JNR_HEADER_DETAIL.DMV_POICY_OWNER_CITY,
        JNR_HEADER_DETAIL.DMV_POLICY_OWNER_STATE,
        JNR_HEADER_DETAIL.DMV_POLICY_OWNER_ZIP_CODE,
        JNR_HEADER_DETAIL.DMV_TRANSACTION_TYPE_CODE,
        JNR_HEADER_DETAIL.DMV_POLICY_EFFECTIVE_DATE,
        JNR_HEADER_DETAIL.DMV_POLICY_CANCELLATION_DATE,
        JNR_HEADER_DETAIL.DMV_DATE_STAMP,
        JNR_HEADER_DETAIL.DMV_POLICY_NUMBER,
        JNR_HEADER_DETAIL.source_record_id,
        JNR_HEADER_DETAIL.DMV_ORIG_DUE_DATE,
        JNR_HEADER_DETAIL.DMV_REC_TYPE_SORT_ORDER,
        JNR_HEADER_DETAIL.ROW_ORIGIN,
        JNR_HEADER_DETAIL.VERSION_NBR,
        JNR_HEADER_DETAIL.DMV_RESERVED,
        JNR_HEADER_DETAIL.CREATE_DATE,
        JNR_HEADER_DETAIL.MAPPING_NAME,
        UPPER(DMV_VIN) AS DMV_VIN_upper,
        TO_CHAR(TO_DATE(JNR_HEADER_DETAIL.DMV_ORIG_DUE_DATE), 'MMDDYYYY') AS DMV_ORIG_DUE_DATE_OUT,
        RPAD(DMV_VIN_upper, 19, ' ') AS OUT_DMV_VIN,
        RPAD(DMV_DRIVER_LICENSE_NUMBER, 15, ' ') AS OUT_DMV_DRIVER_LICENSE_NUMBER,
        RPAD(DMV_MAKE_OF_CAR, 5, ' ') AS OUT_DMV_MAKE_OF_CAR,
        RPAD(DMV_YEAR_OF_CAR, 4, ' ') AS OUT_DMV_YEAR_OF_CAR,
        RPAD(DMV_MODEL_OF_CAR, 5, ' ') AS OUT_DMV_MODEL_OF_CAR,
        RPAD(DMV_INS_COMPANY_CD, 4, ' ') AS OUT_DMV_INS_COMPANY_CD,
        RPAD(DMV_POLICY_OWNER_STREET_ADDR, 30, ' ') AS OUT_DMV_POLICY_OWNER_STREET_ADDR,
        RPAD(DMV_POICY_OWNER_CITY, 20, ' ') AS OUT_DMV_POICY_OWNER_CITY,
        RPAD(DMV_POLICY_OWNER_STATE, 2, ' ') AS OUT_DMV_POLICY_OWNER_STATE,
        RPAD(DMV_POLICY_OWNER_ZIP_CODE, 9, ' ') AS OUT_DMV_POLICY_OWNER_ZIP_CODE,
        RPAD(DMV_TRANSACTION_TYPE_CODE, 1, ' ') AS OUT_DMV_TRANSACTION_TYPE_CODE, -- Include here
        RPAD(DMV_POLICY_EFFECTIVE_DATE, 8, ' ') AS OUT_DMV_POLICY_EFFECTIVE_DATE,
        RPAD(DMV_POLICY_CANCELLATION_DATE, 8, ' ') AS OUT_DMV_POLICY_CANCELLATION_DATE,
        RPAD(DMV_DATE_STAMP, 8, ' ') AS OUT_DMV_DATE_STAMP,
        RPAD(DMV_POLICY_NUMBER, 30, ' ') AS OUT_DMV_POLICY_NUMBER,
        TO_CHAR(CURRENT_TIMESTAMP, 'HHMMSS') AS DMV_TIME_STAMP,
        TO_CHAR(CURRENT_TIMESTAMP, 'MMDDYYYY') AS DMV_DATE_STAMP1,
        'NJ_DMV_DW' AS BUREAU_CD,
        'Y' AS CURRENT_BATCH_CYCLE_IND,
        'NJ' AS SRCE_SYS_CD,
        LKP_CYCLE_DUE_DATE.BATCH_END_DT
    FROM 
        JNR_HEADER_DETAIL
    LEFT JOIN (
        SELECT 
            BATCH_END_DT,
            BUREAU_CD,
            CURRENT_BATCH_CYCLE_IND,
            SRCE_SYS_CD,
            ROW_NUMBER() OVER(PARTITION BY BUREAU_CD, CURRENT_BATCH_CYCLE_IND, SRCE_SYS_CD ORDER BY BUREAU_CD, CURRENT_BATCH_CYCLE_IND, SRCE_SYS_CD) AS rn
        FROM 
            BURRPT.BATCH_BUILD_DATE_CTL
        QUALIFY 
            rn = 1
    ) LKP_CYCLE_DUE_DATE
    ON 
        LKP_CYCLE_DUE_DATE.BUREAU_CD = 'NJ_DMV_DW'
        AND LKP_CYCLE_DUE_DATE.CURRENT_BATCH_CYCLE_IND = 'Y'
        AND LKP_CYCLE_DUE_DATE.SRCE_SYS_CD = 'NJ'
),

EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
    -- Now selecting OUT_DMV_TRANSACTION_TYPE_CODE in this CTE
    SELECT 
        source_record_id,
        OUT_DMV_VIN,
        OUT_DMV_DRIVER_LICENSE_NUMBER,
        OUT_DMV_MAKE_OF_CAR,
        OUT_DMV_YEAR_OF_CAR,
        OUT_DMV_MODEL_OF_CAR,
        OUT_DMV_INS_COMPANY_CD,
        OUT_DMV_POLICY_OWNER_STREET_ADDR,
        OUT_DMV_POICY_OWNER_CITY,
        OUT_DMV_POLICY_OWNER_STATE,
        OUT_DMV_POLICY_OWNER_ZIP_CODE,
        OUT_DMV_TRANSACTION_TYPE_CODE, -- Ensure itâ€™s selected here
        OUT_DMV_POLICY_EFFECTIVE_DATE,
        OUT_DMV_POLICY_CANCELLATION_DATE,
        OUT_DMV_DATE_STAMP,
        OUT_DMV_POLICY_NUMBER,
        DMV_ORIG_DUE_DATE_OUT AS DMV_ORIG_DUE_DATE,
        RPAD(' ', 31) AS FILLER,
        OUT_DMV_VIN || OUT_DMV_DRIVER_LICENSE_NUMBER || OUT_DMV_MAKE_OF_CAR || OUT_DMV_YEAR_OF_CAR || OUT_DMV_MODEL_OF_CAR || 
        OUT_DMV_INS_COMPANY_CD || OUT_DMV_POLICY_OWNER_STREET_ADDR || OUT_DMV_POICY_OWNER_CITY || OUT_DMV_POLICY_OWNER_STATE || 
        OUT_DMV_POLICY_OWNER_ZIP_CODE || OUT_DMV_TRANSACTION_TYPE_CODE || OUT_DMV_POLICY_EFFECTIVE_DATE || 
        OUT_DMV_POLICY_CANCELLATION_DATE || OUT_DMV_DATE_STAMP || OUT_DMV_POLICY_NUMBER || FILLER AS DETAIL,
        2 AS SORT_ORDER
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
)
