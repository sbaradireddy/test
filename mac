WITH SQ_NJ_DMV_MTHLY_MERGE AS (
    SELECT 
        DMV_VIN,
        DMV_DRIVER_LICENSE_NUMBER,
        DMV_MAKE_OF_CAR,
        DMV_YEAR_OF_CAR,
        DMV_MODEL_OF_CAR,
        DMV_INS_COMPANY_CD,
        DMV_POLICY_OWNER_STREET_ADDR,
        DMV_POICY_OWNER_CITY,
        DMV_POLICY_OWNER_STATE,
        DMV_POLICY_OWNER_ZIP_CODE,
        DMV_TRANSACTION_TYPE_CODE,
        DMV_POLICY_EFFECTIVE_DATE,
        DMV_POLICY_CANCELLATION_DATE,
        DMV_DATE_STAMP,
        DMV_POLICY_NUMBER,
        FILENAME,
        HEADER,
        TRAILER
    FROM rrm_files.FWF_NJ_DMV_MTHLY_MERGE
),

INIT_TRAILER_VALUES AS (
    SELECT 
        DMV_INS_COMPANY_CD,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        1 AS INITIAL_TOTAL_RECORDS_COUNT,
        IFF(DMV_TRANSACTION_TYPE_CODE = 'N', 1, 0) AS INITIAL_TOTAL_NEW_POLICIES,
        IFF(DMV_TRANSACTION_TYPE_CODE = 'C', 1, 0) AS INITIAL_TOTAL_CANCELLED_POLICIES,
        RPAD('TRAILER', 7, ' ') AS DMV_RECORD_NAME,
        RPAD(' ', 151, ' ') AS FILLER
    FROM SQ_NJ_DMV_MTHLY_MERGE
),

AGG_TRAILER_VALUES AS (
    SELECT 
        DMV_INS_COMPANY_CD,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        SUM(INITIAL_TOTAL_RECORDS_COUNT) OVER () AS TOTAL_RECORDS_COUNT,
        SUM(INITIAL_TOTAL_NEW_POLICIES) OVER () AS TOTAL_NEW_POLICIES,
        SUM(INITIAL_TOTAL_CANCELLED_POLICIES) OVER () AS TOTAL_CANCELLED_POLICIES,
        DMV_RECORD_NAME,
        FILLER
    FROM INIT_TRAILER_VALUES
),

EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    SELECT 
        DMV_INS_COMPANY_CD,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        TOTAL_RECORDS_COUNT,
        TOTAL_NEW_POLICIES,
        TOTAL_CANCELLED_POLICIES,
        DMV_RECORD_NAME,
        FILLER,
        DMV_RECORD_NAME || DMV_INS_COMPANY_CD || DMV_DATE_STAMP || 
        LPAD(TOTAL_RECORDS_COUNT, 8, '0') || LPAD(TOTAL_NEW_POLICIES, 8, '0') || 
        LPAD(TOTAL_CANCELLED_POLICIES, 8, '0') || FILLER AS TRAILER
    FROM AGG_TRAILER_VALUES
),

EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
    SELECT 
        DMV_VIN,
        DMV_DRIVER_LICENSE_NUMBER,
        DMV_MAKE_OF_CAR,
        DMV_YEAR_OF_CAR,
        DMV_MODEL_OF_CAR,
        DMV_INS_COMPANY_CD,
        DMV_POLICY_OWNER_STREET_ADDR,
        DMV_POICY_OWNER_CITY,
        DMV_POLICY_OWNER_STATE,
        DMV_POLICY_OWNER_ZIP_CODE,
        DMV_TRANSACTION_TYPE_CODE,
        DMV_POLICY_EFFECTIVE_DATE,
        DMV_POLICY_CANCELLATION_DATE,
        DMV_DATE_STAMP,
        DMV_POLICY_NUMBER,
        RPAD(' ', 31) AS FILLER,
        DMV_VIN || DMV_DRIVER_LICENSE_NUMBER || DMV_MAKE_OF_CAR || DMV_YEAR_OF_CAR || DMV_MODEL_OF_CAR || 
        DMV_INS_COMPANY_CD || DMV_POLICY_OWNER_STREET_ADDR || DMV_POICY_OWNER_CITY || DMV_POLICY_OWNER_STATE || 
        DMV_POLICY_OWNER_ZIP_CODE || DMV_TRANSACTION_TYPE_CODE || DMV_POLICY_EFFECTIVE_DATE || 
        DMV_POLICY_CANCELLATION_DATE || DMV_DATE_STAMP || DMV_POLICY_NUMBER || FILLER AS DETAIL
    FROM SQ_NJ_DMV_MTHLY_MERGE
)
