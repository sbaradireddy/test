WITH SQ_NJ_DMV_MTHLY_MERGE AS (
    SELECT 
        DMV_VIN,
        DMV_DRIVER_LICENSE_NUMBER,
        DMV_MAKE_OF_CAR,
        DMV_YEAR_OF_CAR,
        DMV_MODEL_OF_CAR,
        DMV_INS_COMPANY_CD,
        DMV_POLICY_OWNER_STREET_ADDR,
        DMV_POICY_OWNER_CITY,
        DMV_POLICY_OWNER_STATE,
        DMV_POLICY_OWNER_ZIP_CODE,
        DMV_TRANSACTION_TYPE_CODE,
        DMV_POLICY_EFFECTIVE_DATE,
        DMV_POLICY_CANCELLATION_DATE,
        DMV_DATE_STAMP,
        DMV_POLICY_NUMBER,
        FILENAME,
        HEADER,
        TRAILER
    FROM rrm_files.FWF_NJ_DMV_MTHLY_MERGE
),
-- Step 1: Initialize base values for the trailer section
INIT_TRAILER_VALUES AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        1 AS INITIAL_TOTAL_RECORDS_COUNT,
        IFF(DMV_TRANSACTION_TYPE_CODE = 'N', 1, 0) AS INITIAL_TOTAL_NEW_POLICIES,
        IFF(DMV_TRANSACTION_TYPE_CODE = 'C', 1, 0) AS INITIAL_TOTAL_CANCELLED_POLICIES,
        RPAD('TRAILER', 7, ' ') AS DMV_RECORD_NAME,
        RPAD(' ', 151, ' ') AS FILLER
    FROM SQ_NJ_DMV_MTHLY_MERGE
),

-- Step 2: Calculate total counts by aggregating values from INIT_TRAILER_VALUES
AGG_TRAILER_VALUES AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        SUM(INITIAL_TOTAL_RECORDS_COUNT) OVER () AS TOTAL_RECORDS_COUNT_V,
        SUM(INITIAL_TOTAL_NEW_POLICIES) OVER () AS TOTAL_NEW_POLICIES_V,
        SUM(INITIAL_TOTAL_CANCELLED_POLICIES) OVER () AS TOTAL_CANCELLED_POLICIES_V,
        DMV_RECORD_NAME,
        FILLER
    FROM INIT_TRAILER_VALUES
),

-- Step 3: Final Trailer Expression with Padding and Formatting
EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        DMV_TRANSACTION_TYPE_CODE,
        LPAD(TOTAL_RECORDS_COUNT_V + 2, 8, '0') AS TOTAL_RECORDS_COUNT,  -- Adding 2 to total count
        TOTAL_NEW_POLICIES_V AS TOTAL_NEW_POLICIES,
        TOTAL_CANCELLED_POLICIES_V AS TOTAL_CANCELLED_POLICIES,
        DMV_RECORD_NAME,
        FILLER,
        DMV_RECORD_NAME || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || 
        LPAD(TOTAL_RECORDS_COUNT_V, 8, '0') || LPAD(TOTAL_NEW_POLICIES_V, 8, '0') || 
        LPAD(TOTAL_CANCELLED_POLICIES_V, 8, '0') || FILLER AS TRAILER
    FROM AGG_TRAILER_VALUES
)
,
-- EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
--     -- Writing query for expression function
--     SELECT 
--         source_record_id,
--         OUT_DMV_VIN,
--         OUT_DMV_DRIVER_LICENSE_NUMBER,
--         OUT_DMV_MAKE_OF_CAR,
--         OUT_DMV_YEAR_OF_CAR,
--         OUT_DMV_MODEL_OF_CAR,
--         OUT_DMV_INS_COMPANY_CD,
--         OUT_DMV_POLICY_OWNER_STREET_ADDR,
--         OUT_DMV_POICY_OWNER_CITY,
--         OUT_DMV_POLICY_OWNER_STATE,
--         OUT_DMV_POLICY_OWNER_ZIP_CODE,
--         OUT_DMV_TRANSACTION_TYPE_CODE,
--         OUT_DMV_POLICY_EFFECTIVE_DATE,
--         OUT_DMV_POLICY_CANCELLATION_DATE,
--         OUT_DMV_DATE_STAMP,
--         OUT_DMV_POLICY_NUMBER,
--         DMV_ORIG_DUE_DATE_OUT AS DMV_ORIG_DUE_DATE,
--         RPAD(' ', 31) AS FILLER,
--         OUT_DMV_VIN || OUT_DMV_DRIVER_LICENSE_NUMBER || OUT_DMV_MAKE_OF_CAR || OUT_DMV_YEAR_OF_CAR || OUT_DMV_MODEL_OF_CAR || 
--         OUT_DMV_INS_COMPANY_CD || OUT_DMV_POLICY_OWNER_STREET_ADDR || OUT_DMV_POICY_OWNER_CITY || OUT_DMV_POLICY_OWNER_STATE || 
--         OUT_DMV_POLICY_OWNER_ZIP_CODE || OUT_DMV_TRANSACTION_TYPE_CODE || OUT_DMV_POLICY_EFFECTIVE_DATE || 
--         OUT_DMV_POLICY_CANCELLATION_DATE || OUT_DMV_DATE_STAMP || OUT_DMV_POLICY_NUMBER || FILLER AS DETAIL,
--         2 AS SORT_ORDER
--     FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
-- ),

EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    -- Writing query for expression function
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        BATCH_END_DT,
        RPAD('HEADER', 6, ' ') AS DMV_RECORD_NAME,
        'N' AS DMV_FILE_TYPE,
        TO_CHAR(DATEADD('D', 7, LAST_DAY(BATCH_END_DT)), 'MMDDYYYY') AS DMV_ORIG_CYCLE_DUE_DATE_V,
        RPAD(' ', 167, ' ') AS FILLER,
        DMV_RECORD_NAME || DMV_FILE_TYPE || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || DMV_ORIG_CYCLE_DUE_DATE_V || FILLER AS HEADER
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
)
--select * from EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF
,

AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    -- Writing query for Aggregator function
    SELECT 
        TOTAL_NEW_POLICIES,
        DMV_TRANSACTION_TYPE_CODE,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        FILLER,
        source_record_id,
        TOTAL_CANCELLED_POLICIES,
        TOTAL_RECORDS_COUNT,
        DMV_RECORD_NAME,
        
        -- Use window functions without COALESCE for initial aggregation
        MAX(CASE WHEN DMV_TRANSACTION_TYPE_CODE = 'N' THEN TOTAL_NEW_POLICIES END) 
            OVER (PARTITION BY DMV_RECORD_NAME) AS TOTAL_NEW_POLICIES_OUT_RAW,
            
        MAX(CASE WHEN OUT_DMV_TRANSACTION_TYPE_CODE = 'C' THEN TOTAL_CANCELLED_POLICIES END) 
            OVER (PARTITION BY DMV_RECORD_NAME) AS TOTAL_CANCELLED_POLICIES_OUT_RAW,
        
        MAX(TOTAL_RECORDS_COUNT) 
            OVER (PARTITION BY DMV_RECORD_NAME) AS TOTAL_RECORDS_COUNT_OUT_RAW,
        
        ROW_NUMBER() OVER (
            PARTITION BY DMV_RECORD_NAME 
            ORDER BY TOTAL_NEW_POLICIES DESC, OUT_DMV_TRANSACTION_TYPE_CODE DESC, 
            DMV_INS_COMPANY_CD DESC, DMV_TIME_STAMP DESC, DMV_DATE_STAMP DESC, FILLER DESC
        ) AS rn
        
    FROM EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF
    QUALIFY rn = 1
),

-- Wrapping the COALESCE logic after window aggregation
AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FINAL AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        FILLER,
        TOTAL_RECORDS_COUNT,
        DMV_RECORD_NAME,
        
        -- Use COALESCE here after aggregation
        COALESCE(TOTAL_NEW_POLICIES_OUT_RAW, 0) AS TOTAL_NEW_POLICIES_OUT,
        COALESCE(TOTAL_CANCELLED_POLICIES_OUT_RAW, 0) AS TOTAL_CANCELLED_POLICIES_OUT,
        COALESCE(TOTAL_RECORDS_COUNT_OUT_RAW, 0) AS TOTAL_RECORDS_COUNT_OUT
        
    FROM AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FF
)
--select * from AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FINAL
,
AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    -- Writing query for Aggregator function
    SELECT 
        source_record_id,
        HEADER,
        1 AS SORT_ORDER
    FROM EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF
    GROUP BY HEADER,source_record_id
)
--select * from AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF
,

EXP_TRAILER AS (
    -- Writing query for expression function
    SELECT 
        source_record_id,
         TOTAL_NEW_POLICIES,  -- Use the correct alias
        DMV_TRANSACTION_TYPE_CODE,
        TOTAL_CANCELLED_POLICIES,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        FILLER,
        DMV_RECORD_NAME,
        TOTAL_RECORDS_COUNT,  -- Use the correct alias
        
        -- Check for NULL and handle appropriately
        IFF(TOTAL_CANCELLED_POLICIES IS NULL, 0, TOTAL_CANCELLED_POLICIES) AS TOTAL_CANCELLED_POLICIES,
        
        -- Construct TRAILER field by concatenating fields
        DMV_RECORD_NAME || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || 
        LPAD(TOTAL_RECORDS_COUNT, 8, '0') || LPAD(TOTAL_NEW_POLICIES, 8, '0') || 
        LPAD(TOTAL_CANCELLED_POLICIES, 8, '0') || FILLER AS TRAILER,
        3 AS SORT_ORDER
   -- FROM AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FF
   FROM EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF
),

UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    -- Writing query for union
    SELECT 
        source_record_id,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER AS INPUT_RECORD
    FROM AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF
    UNION 
    SELECT 
        source_record_id,
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.DETAIL AS INPUT_RECORD
    FROM EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF
    UNION 
    SELECT 
        source_record_id,
        EXP_TRAILER.TRAILER AS INPUT_RECORD
    FROM EXP_TRAILER
),

EXP_SORT AS (
    -- Writing query for expression function
    SELECT 
        source_record_id,
        INPUT_RECORD,
        DECODE(SUBSTR(INPUT_RECORD, 1, 6), 'HEADER', 1, 'TRAILE', 3, 2) AS SORT_ORDER
    FROM UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF
),

SRT_HDR_DTL_TRLR AS (
    SELECT 
        EXP_SORT.source_record_id,
        INPUT_RECORD,
        SORT_ORDER
    FROM EXP_SORT
    ORDER BY SORT_ORDER
),

FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    -- Writing query for target definition
    SELECT 
        TRIM(INPUT_RECORD) :: VARCHAR(200) AS DMV_RECORD
    FROM SRT_HDR_DTL_TRLR
)

SELECT * FROM FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF
