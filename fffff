WITH EXP_NJ_DMV_MTHLY_MERGE_DATA AS (
    -- Define `OUT_DMV_VIN` and other transformed columns here
    SELECT 
        source_record_id,
        UPPER(DMV_VIN) AS DMV_VIN_upper,
        RPAD(DMV_VIN_upper, 19, ' ') AS OUT_DMV_VIN, -- Ensure OUT_DMV_VIN is defined here
        RPAD(DMV_DRIVER_LICENSE_NUMBER, 15, ' ') AS OUT_DMV_DRIVER_LICENSE_NUMBER,
        -- Define other `OUT_*` fields similarly
        -- Additional fields and transformations as needed
    FROM JNR_HEADER_DETAIL
),

EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
    -- Pass `OUT_DMV_VIN` and other fields to this CTE
    SELECT 
        source_record_id,
        OUT_DMV_VIN,
        OUT_DMV_DRIVER_LICENSE_NUMBER,
        OUT_DMV_MAKE_OF_CAR,
        OUT_DMV_YEAR_OF_CAR,
        OUT_DMV_MODEL_OF_CAR,
        OUT_DMV_INS_COMPANY_CD,
        OUT_DMV_POLICY_OWNER_STREET_ADDR,
        OUT_DMV_POICY_OWNER_CITY,
        OUT_DMV_POLICY_OWNER_STATE,
        OUT_DMV_POLICY_OWNER_ZIP_CODE,
        OUT_DMV_TRANSACTION_TYPE_CODE,
        OUT_DMV_POLICY_EFFECTIVE_DATE,
        OUT_DMV_POLICY_CANCELLATION_DATE,
        OUT_DMV_DATE_STAMP,
        OUT_DMV_POLICY_NUMBER,
        DMV_ORIG_DUE_DATE_OUT AS DMV_ORIG_DUE_DATE,
        RPAD(' ', 31) AS FILLER
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
),

FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    -- Select `OUT_DMV_VIN` and other fields in the final output
    SELECT 
        TRIM(OUT_DMV_VIN)::VARCHAR(19) AS DMV_VIN,
        TRIM(OUT_DMV_DRIVER_LICENSE_NUMBER)::VARCHAR(15) AS DMV_DRIVER_LICENSE_NUMBER,
        TRIM(OUT_DMV_MAKE_OF_CAR)::VARCHAR(5) AS DMV_MAKE_OF_CAR,
        TRIM(OUT_DMV_YEAR_OF_CAR)::VARCHAR(4) AS DMV_YEAR_OF_CAR,
        TRIM(OUT_DMV_MODEL_OF_CAR)::VARCHAR(5) AS DMV_MODEL_OF_CAR,
        TRIM(OUT_DMV_INS_COMPANY_CD)::VARCHAR(4) AS DMV_INS_COMPANY_CD,
        TRIM(OUT_DMV_POLICY_OWNER_STREET_ADDR)::VARCHAR(30) AS DMV_POLICY_OWNER_STREET_ADDR,
        TRIM(OUT_DMV_POICY_OWNER_CITY)::VARCHAR(20) AS DMV_POICY_OWNER_CITY,
        TRIM(OUT_DMV_POLICY_OWNER_STATE)::VARCHAR(2) AS DMV_POLICY_OWNER_STATE,
        TRIM(OUT_DMV_POLICY_OWNER_ZIP_CODE)::VARCHAR(9) AS DMV_POLICY_OWNER_ZIP_CODE,
        TRIM(OUT_DMV_TRANSACTION_TYPE_CODE)::VARCHAR(1) AS DMV_TRANSACTION_TYPE_CODE,
        TRIM(OUT_DMV_POLICY_EFFECTIVE_DATE)::VARCHAR(8) AS DMV_POLICY_EFFECTIVE_DATE,
        TRIM(OUT_DMV_POLICY_CANCELLATION_DATE)::VARCHAR(8) AS DMV_POLICY_CANCELLATION_DATE,
        TRIM(OUT_DMV_DATE_STAMP)::VARCHAR(8) AS DMV_DATE_STAMP,
        TRIM(OUT_DMV_POLICY_NUMBER)::VARCHAR(30) AS DMV_POLICY_NUMBER,
        NULL AS FILENAME,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER AS HEADER_RECORD,
        EXP_TRAILER.TRAILER_RECORD AS TRAILER_RECORD
    FROM EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF
    LEFT JOIN AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF ON AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
    LEFT JOIN EXP_TRAILER ON EXP_TRAILER.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
)

SELECT * FROM FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF;
