WITH EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    SELECT 
        source_record_id,
        DMV_RECORD_NAME || DMV_FILE_TYPE || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || DMV_ORIG_CYCLE_DUE_DATE_V || FILLER AS HEADER
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
),

EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
    SELECT 
        source_record_id,
        OUT_DMV_VIN || OUT_DMV_DRIVER_LICENSE_NUMBER || OUT_DMV_MAKE_OF_CAR || OUT_DMV_YEAR_OF_CAR || OUT_DMV_MODEL_OF_CAR || 
        OUT_DMV_INS_COMPANY_CD || OUT_DMV_POLICY_OWNER_STREET_ADDR || OUT_DMV_POICY_OWNER_CITY || OUT_DMV_POLICY_OWNER_STATE || 
        OUT_DMV_POLICY_OWNER_ZIP_CODE || OUT_DMV_TRANSACTION_TYPE_CODE || OUT_DMV_POLICY_EFFECTIVE_DATE || 
        OUT_DMV_POLICY_CANCELLATION_DATE || OUT_DMV_DATE_STAMP || OUT_DMV_POLICY_NUMBER || RPAD(' ', 31) AS DETAIL
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
),

EXP_TRAILER AS (
    SELECT 
        source_record_id,
        DMV_RECORD_NAME || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || 
        LPAD(TOTAL_RECORDS_COUNT, 8, '0') || LPAD(TOTAL_NEW_POLICIES, 8, '0') || 
        LPAD(TOTAL_CANCELLED_POLICIES, 8, '0') || FILLER AS TRAILER
    FROM AGG_TRAILER_VALUES
),

UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    -- UNION to combine HEADER, DETAIL, and TRAILER records
    SELECT 
        source_record_id,
        HEADER AS INPUT_RECORD
    FROM EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF
    
    UNION ALL
    
    SELECT 
        source_record_id,
        DETAIL AS INPUT_RECORD
    FROM EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF
    
    UNION ALL
    
    SELECT 
        source_record_id,
        TRAILER AS INPUT_RECORD
    FROM EXP_TRAILER
)
