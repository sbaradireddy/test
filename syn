With SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp as ( 
 -- writting query for Source_qualifier override query 
SELECT DMV_INS_COMPANY_CD, replace(TO_VARCHAR(MAX(TO_DATE(
SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,1,2)||'-'||SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,3,2)||'-'||SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,5,4)
))),'-','') DMV_ORIG_CYCLE_DUE_DATE, ROW_ORIGIN 
FROM
 BURRPT.NJ_DMV_MTHLY_MERGE_HEADER_DW ,
--WHERE DMV_INS_COMPANY_CD = DMV_CO_CD
GROUP BY DMV_INS_COMPANY_CD,   ROW_ORIGIN
 )
-- select * from SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp
 , 
 NJ_DMV_MTHLY_MERGE_HEADER as ( 
 -- writting query for Source_qualifier function 
SELECT row_number() over(order by DMV_INS_COMPANY_CD) AS source_record_id,
DMV_INS_COMPANY_CD,
DMV_ORIG_CYCLE_DUE_DATE,
ROW_ORIGIN
FROM BURRPT.NJ_DMV_MTHLY_MERGE_HEADER_DW
 )
 --select * from SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp
 , 
SQ_NJ_DMV_MTHLY_MERGE_DATA_DW_temp as ( 
 -- writting query for Source_qualifier override query 
SELECT NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_ORIG_DUE_DATE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_REC_TYPE_SORT_ORDER, NJ_DMV_MTHLY_MERGE_DATA_DW.ROW_ORIGIN, NJ_DMV_MTHLY_MERGE_DATA_DW.VERSION_NBR, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_VIN, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_DRIVER_LICENSE_NUMBER, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_MAKE_OF_CAR, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_YEAR_OF_CAR, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_MODEL_OF_CAR, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_INS_COMPANY_CD, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_OWNER_STREET_ADDR, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POICY_OWNER_CITY, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_OWNER_STATE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_OWNER_ZIP_CODE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_TRANSACTION_TYPE_CODE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_EFFECTIVE_DATE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_CANCELLATION_DATE, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_DATE_STAMP, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_POLICY_NUMBER, NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_RESERVED, NJ_DMV_MTHLY_MERGE_DATA_DW.CREATE_DATE, NJ_DMV_MTHLY_MERGE_DATA_DW.MAPPING_NAME 
FROM
 burrpt.NJ_DMV_MTHLY_MERGE_DATA_DW
--WHERE NJ_DMV_MTHLY_MERGE_DATA_DW.DMV_INS_COMPANY_CD = ''{{DMV_Co_Cd}}''
ORDER BY DMV_TRANSACTION_TYPE_CODE DESC , DMV_VIN ASC
 )
 --select * from SQ_NJ_DMV_MTHLY_MERGE_DATA_DW_temp
 , 
 NJ_DMV_MTHLY_MERGE_DATA_DW as ( 
 -- writting query for Source_qualifier function 
SELECT row_number() over(order by DMV_ORIG_DUE_DATE) AS source_record_id,
DMV_ORIG_DUE_DATE,
DMV_REC_TYPE_SORT_ORDER,
ROW_ORIGIN,
VERSION_NBR,
DMV_VIN,
DMV_DRIVER_LICENSE_NUMBER,
DMV_MAKE_OF_CAR,
DMV_YEAR_OF_CAR,
DMV_MODEL_OF_CAR,
DMV_INS_COMPANY_CD,
DMV_POLICY_OWNER_STREET_ADDR,
DMV_POICY_OWNER_CITY,
DMV_POLICY_OWNER_STATE,
DMV_POLICY_OWNER_ZIP_CODE,
DMV_TRANSACTION_TYPE_CODE,
DMV_POLICY_EFFECTIVE_DATE,
DMV_POLICY_CANCELLATION_DATE,
DMV_DATE_STAMP,
DMV_POLICY_NUMBER,
DMV_RESERVED,
CREATE_DATE,
MAPPING_NAME
FROM SQ_NJ_DMV_MTHLY_MERGE_DATA_DW_temp
 ) 
--select * from SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp
 , 
exp_CHANGE_DATE_FORMAT as (
        -- writting query for expression function
SELECT NJ_DMV_MTHLY_MERGE_HEADER_DW.DMV_ORIG_CYCLE_DUE_DATE,
             --  NJ_DMV_MTHLY_MERGE_HEADER_DW.source_record_id,
               NJ_DMV_MTHLY_MERGE_HEADER_DW.DMV_INS_COMPANY_CD,
               NJ_DMV_MTHLY_MERGE_HEADER_DW.ROW_ORIGIN,
               SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,5,2)||SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,7,2)||SUBSTR(DMV_ORIG_CYCLE_DUE_DATE,1,4) AS out_DMV_ORIG_CYCLE_DUE_DATE,
               lkp_VERSION_NBR.VERSION_NBR
          FROM BURRPT.NJ_DMV_MTHLY_MERGE_HEADER_DW NJ_DMV_MTHLY_MERGE_HEADER_DW
          left join -- writting query for lookup function
 (
                SELECT NJ_DMV_MTHLY_MERGE_HEADER_DW.VERSION_NBR as VERSION_NBR,
                       NJ_DMV_MTHLY_MERGE_HEADER_DW.DMV_INS_COMPANY_CD as DMV_INS_COMPANY_CD,
                       NJ_DMV_MTHLY_MERGE_HEADER_DW.DMV_ORIG_CYCLE_DUE_DATE as DMV_ORIG_CYCLE_DUE_DATE,
                       NJ_DMV_MTHLY_MERGE_HEADER_DW.ROW_ORIGIN as ROW_ORIGIN,
                      row_number() over(partition by DMV_INS_COMPANY_CD, DMV_ORIG_CYCLE_DUE_DATE, ROW_ORIGIN order by DMV_INS_COMPANY_CD, dmv_orig_cycle_due_date, row_origin,VERSION_NBR ASC) as rn
                  FROM BURRPT.NJ_DMV_MTHLY_MERGE_HEADER_DW qualify rn = 1
                 ORDER BY DMV_INS_COMPANY_CD,
                          dmv_orig_cycle_due_date,
                          row_origin,
                          VERSION_NBR ASC
               ) lkp_VERSION_NBR
            on lkp_VERSION_NBR.DMV_INS_COMPANY_CD=NJ_DMV_MTHLY_MERGE_HEADER.DMV_INS_COMPANY_CD
           AND lkp_VERSION_NBR.DMV_ORIG_CYCLE_DUE_DATE=SUBSTR(NJ_DMV_MTHLY_MERGE_HEADER.DMV_ORIG_CYCLE_DUE_DATE,5,2)||SUBSTR(NJ_DMV_MTHLY_MERGE_HEADER.DMV_ORIG_CYCLE_DUE_DATE,7,2)||SUBSTR(NJ_DMV_MTHLY_MERGE_HEADER.DMV_ORIG_CYCLE_DUE_DATE,1,4)
           AND lkp_VERSION_NBR.ROW_ORIGIN=NJ_DMV_MTHLY_MERGE_HEADER.ROW_ORIGIN
       ) 
     select * from exp_CHANGE_DATE_FORMAT
