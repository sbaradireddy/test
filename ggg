WITH SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_HEADER AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_DATA_DW_temp AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_DATA_DW AS (
    ...
),
exp_CHANGE_DATE_FORMAT AS (
    ...
),
EXP_DETAIL AS (
    ...
),
EXP_HEADER AS (
    ...
),
JNR_HEADER_DETAIL AS (
    ...
),
EXP_NJ_DMV_MTHLY_MERGE_DATA AS (
    ...
),
INIT_TRAILER_VALUES AS (
    SELECT 
        source_record_id,
        OUT_DMV_INS_COMPANY_CD AS DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP1 AS DMV_DATE_STAMP,
        OUT_DMV_TRANSACTION_TYPE_CODE,
        1 AS INITIAL_TOTAL_RECORDS_COUNT,
        IFF(OUT_DMV_TRANSACTION_TYPE_CODE = 'N', 1, 0) AS INITIAL_TOTAL_NEW_POLICIES,
        IFF(OUT_DMV_TRANSACTION_TYPE_CODE = 'C', 1, 0) AS INITIAL_TOTAL_CANCELLED_POLICIES,
        RPAD('TRAILER', 7, ' ') AS DMV_RECORD_NAME,
        RPAD(' ', 151, ' ') AS FILLER,
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.FILENAME  -- Include FILENAME here
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
    LEFT JOIN EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF 
        ON EXP_NJ_DMV_MTHLY_MERGE_DATA.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
),

AGG_TRAILER_VALUES AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        OUT_DMV_TRANSACTION_TYPE_CODE,
        SUM(INITIAL_TOTAL_RECORDS_COUNT) OVER () AS TOTAL_RECORDS_COUNT_V,
        SUM(INITIAL_TOTAL_NEW_POLICIES) OVER () AS TOTAL_NEW_POLICIES_V,
        SUM(INITIAL_TOTAL_CANCELLED_POLICIES) OVER () AS TOTAL_CANCELLED_POLICIES_V,
        DMV_RECORD_NAME,
        FILLER,
        FILENAME  -- Reference FILENAME here
    FROM INIT_TRAILER_VALUES
),

EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    SELECT 
        source_record_id,
        DMV_INS_COMPANY_CD,
        DMV_TIME_STAMP,
        DMV_DATE_STAMP,
        OUT_DMV_TRANSACTION_TYPE_CODE,
        LPAD(TOTAL_RECORDS_COUNT_V + 2, 8, '0') AS TOTAL_RECORDS_COUNT,  
        TOTAL_NEW_POLICIES_V AS TOTAL_NEW_POLICIES,
        TOTAL_CANCELLED_POLICIES_V AS TOTAL_CANCELLED_POLICIES,
        DMV_RECORD_NAME,
        FILLER,
        FILENAME,  -- Include FILENAME here
        DMV_RECORD_NAME || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || 
        LPAD(TOTAL_RECORDS_COUNT_V, 8, '0') || LPAD(TOTAL_NEW_POLICIES_V, 8, '0') || 
        LPAD(TOTAL_CANCELLED_POLICIES_V, 8, '0') || FILLER AS TRAILER
    FROM AGG_TRAILER_VALUES
),

-- Continue with other CTEs...

EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    ...
),

AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FINAL AS (
    ...
),

AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    ...
),

EXP_TRAILER AS (
    ...
),

UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    ...
),

EXP_SORT AS (
    ...
),

SRT_HDR_DTL_TRLR AS (
    ...
),

FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    ...
)

SELECT * FROM FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF;
