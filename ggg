WITH SQ_NJ_DMV_MTHLY_MERGE_HEADER_temp AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_HEADER AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_DATA_DW_temp AS (
    ...
),
SQ_NJ_DMV_MTHLY_MERGE_DATA_DW AS (
    ...
),
exp_CHANGE_DATE_FORMAT AS (
    ...
),
EXP_DETAIL AS (
    ...
),
EXP_HEADER AS (
    ...
),
JNR_HEADER_DETAIL AS (
    ...
),
EXP_NJ_DMV_MTHLY_MERGE_DATA AS (
    ...
),
INIT_TRAILER_VALUES AS (
    ...
),
AGG_TRAILER_VALUES AS (
    ...
),
EXP_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    ...
),
EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF AS (
    ...
),

-- Updated EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF to reference FILENAME and qualify OUT_DMV_INS_COMPANY_CD
EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    SELECT 
        EXP_NJ_DMV_MTHLY_MERGE_DATA.source_record_id,
        EXP_NJ_DMV_MTHLY_MERGE_DATA.OUT_DMV_INS_COMPANY_CD AS DMV_INS_COMPANY_CD,
        EXP_NJ_DMV_MTHLY_MERGE_DATA.DMV_TIME_STAMP,
        EXP_NJ_DMV_MTHLY_MERGE_DATA.DMV_DATE_STAMP1 AS DMV_DATE_STAMP,
        EXP_NJ_DMV_MTHLY_MERGE_DATA.BATCH_END_DT,
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.FILENAME,  -- Reference to FILENAME
        RPAD('HEADER', 6, ' ') AS DMV_RECORD_NAME,
        'N' AS DMV_FILE_TYPE,
        TO_CHAR(DATEADD('D', 7, LAST_DAY(TO_DATE(EXP_NJ_DMV_MTHLY_MERGE_DATA.BATCH_END_DT))), 'MMDDYYYY') AS DMV_ORIG_CYCLE_DUE_DATE_V,
        RPAD(' ', 167, ' ') AS FILLER,
        DMV_RECORD_NAME || DMV_FILE_TYPE || DMV_INS_COMPANY_CD || DMV_TIME_STAMP || DMV_DATE_STAMP || DMV_ORIG_CYCLE_DUE_DATE_V || FILLER AS HEADER
    FROM EXP_NJ_DMV_MTHLY_MERGE_DATA
    LEFT JOIN EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF 
        ON EXP_NJ_DMV_MTHLY_MERGE_DATA.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
),

AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FF AS (
    ...
),

AGG_NJ_DMV_MTHLY_MERGE_TRAILER_FINAL AS (
    ...
),

AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF AS (
    SELECT 
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.source_record_id,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.FILENAME,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER,
        1 AS SORT_ORDER
    FROM EXP_NJ_DMV_MTHLY_MERGE_HEADER_FF AS AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF
    GROUP BY AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER, AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.FILENAME, AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.source_record_id
),

EXP_TRAILER AS (
    ...
),

UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
    SELECT 
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.source_record_id,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER AS INPUT_RECORD
    FROM AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF
    UNION 
    SELECT 
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id,
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.DETAIL AS INPUT_RECORD
    FROM EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF
    UNION 
    SELECT 
        EXP_TRAILER.source_record_id,
        EXP_TRAILER.TRAILER AS INPUT_RECORD
    FROM EXP_TRAILER
),

EXP_SORT AS (
    SELECT 
        UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF.source_record_id,
        UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF.FILENAME,
        UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF.INPUT_RECORD,
        DECODE(SUBSTR(UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF.INPUT_RECORD, 1, 6), 'HEADER', 1, 'TRAILE', 3, 2) AS SORT_ORDER
    FROM UNI_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF
),

SRT_HDR_DTL_TRLR AS (
    SELECT 
        EXP_SORT.source_record_id,
        EXP_SORT.INPUT_RECORD,
        EXP_SORT.FILENAME,
        EXP_SORT.SORT_ORDER
    FROM EXP_SORT
    ORDER BY EXP_SORT.SORT_ORDER
),

FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF AS (
     SELECT 
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_VIN)::VARCHAR(19) AS DMV_VIN,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_DRIVER_LICENSE_NUMBER)::VARCHAR(15) AS DMV_DRIVER_LICENSE_NUMBER,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_MAKE_OF_CAR)::VARCHAR(5) AS DMV_MAKE_OF_CAR,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_YEAR_OF_CAR)::VARCHAR(4) AS DMV_YEAR_OF_CAR,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_MODEL_OF_CAR)::VARCHAR(5) AS DMV_MODEL_OF_CAR,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_INS_COMPANY_CD)::VARCHAR(4) AS DMV_INS_COMPANY_CD,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_OWNER_STREET_ADDR)::VARCHAR(30) AS DMV_POLICY_OWNER_STREET_ADDR,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POICY_OWNER_CITY)::VARCHAR(20) AS DMV_POICY_OWNER_CITY,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_OWNER_STATE)::VARCHAR(2) AS DMV_POLICY_OWNER_STATE,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_OWNER_ZIP_CODE)::VARCHAR(9) AS DMV_POLICY_OWNER_ZIP_CODE,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_TRANSACTION_TYPE_CODE)::VARCHAR(1) AS DMV_TRANSACTION_TYPE_CODE,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_EFFECTIVE_DATE)::VARCHAR(8) AS DMV_POLICY_EFFECTIVE_DATE,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_CANCELLATION_DATE)::VARCHAR(8) AS DMV_POLICY_CANCELLATION_DATE,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_DATE_STAMP)::VARCHAR(8) AS DMV_DATE_STAMP,
        TRIM(EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.OUT_DMV_POLICY_NUMBER)::VARCHAR(30) AS DMV_POLICY_NUMBER,
        EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.FILENAME,
        AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.HEADER,
        EXP_TRAILER.TRAILER
    FROM EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF
    LEFT JOIN AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF ON AGG_NJ_DMV_MTHLY_MERGE_HEADER_FF.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
    LEFT JOIN EXP_TRAILER ON EXP_TRAILER.source_record_id = EXP_EXP_NJ_DMV_MTHLY_MERGE_DETAIL_FF.source_record_id
)

SELECT * FROM FINAL_SELECT_NJ_DMV_GENERIC_MTHLY_MERGE_DATA_FF;
