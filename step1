RPAD(CASE 
         WHEN HSE_NUM IS NOT NULL THEN UPPER(LTRIM(RTRIM(HSE_NUM))) || ' ' 
         ELSE ''
     END || UPPER(LTRIM(RTRIM(ADDRESS1))), 30, ' ') AS DMV_POLICY_OWNER_STREET_ADDR



1. Check for Join Issues:
Ensure that the missing POL_PK is present in all necessary tables and that the join conditions are correct. Since multiple tables are being joined, a missing or incorrect join condition can cause the record to be excluded from the result set.

Run a simple query to check whether the record with the missing POL_PK exists in all the required tables, like this:

sql
Copy code
SELECT 
    T_POL_ADDR_DIM_HST.POL_PK AS addr_pol_pk,
    T_POL_PTY_DIM_HST.POL_PK AS pty_pol_pk,
    T_POL_FLG_DIM_HST.POL_PK AS flg_pol_pk,
    T_POL_CT_DIM_HST.POL_PK AS ct_pol_pk,
    T_POL_VEH_UNIT_DIM_HST.POL_PK AS veh_pol_pk,
    T_POL_DIM_HST.POL_PK AS dim_pol_pk
FROM 
    T_POL_ADDR_DIM_HST
LEFT JOIN 
    T_POL_PTY_DIM_HST ON T_POL_ADDR_DIM_HST.POL_PK = T_POL_PTY_DIM_HST.POL_PK
LEFT JOIN 
    T_POL_FLG_DIM_HST ON T_POL_ADDR_DIM_HST.POL_PK = T_POL_FLG_DIM_HST.POL_PK
LEFT JOIN 
    T_POL_CT_DIM_HST ON T_POL_ADDR_DIM_HST.POL_PK = T_POL_CT_DIM_HST.POL_PK
LEFT JOIN 
    T_POL_VEH_UNIT_DIM_HST ON T_POL_ADDR_DIM_HST.POL_PK = T_POL_VEH_UNIT_DIM_HST.POL_PK
LEFT JOIN 
    T_POL_DIM_HST ON T_POL_ADDR_DIM_HST.POL_PK = T_POL_DIM_HST.POL_PK
WHERE 
    T_POL_ADDR_DIM_HST.POL_PK = '<MISSING_POL_PK>';
This query will help identify if the record exists in each table. If one or more of the tables does not have the corresponding POL_PK, that may explain why the record is missing.

2. Check Filters in the WHERE Clause:
Your query has several conditions in the WHERE clause that may be filtering out the record with the missing POL_PK. For example, these lines may be excluding it:

sql
Copy code
RTRIM(T_Pol_Dim_Hst.PRCSG_GRP_CD) IN ('HP', 'PL') AND
RTRIM(T_POL_DIM_HST.STATE_CD)='NJ' AND
RTRIM(T_Pol_Dim_Hst.CO_CD) IN ('HPPREF', 'HPPROP', ...) AND
RTRIM(T_Pol_Dim_Hst.CORP_CD) IN ('HIGHPOINT', 'Palisades') AND
...
Verify whether the missing POL_PK record satisfies all the conditions in the WHERE clause. You can check it by running:

sql
Copy code
SELECT *
FROM T_POL_DIM_HST
WHERE POL_PK = '<MISSING_POL_PK>';
If this query does not return the record, check which filter might be excluding it.

3. Use NOT EXISTS Clause:
Your query also has a NOT EXISTS condition that excludes records that match certain criteria:

sql
Copy code
AND NOT EXISTS (
    SELECT *
    FROM ERM.T_ESS_SMOKETEST_POLICIES
    WHERE ERM.T_ESS_SMOKETEST_POLICIES.STATE_CD=T_POL_DIM_HST.STATE_CD
    AND ERM.T_ESS_SMOKETEST_POLICIES.POL_NUM=T_POL_DIM_HST.POL_NUM
)
This NOT EXISTS condition might be filtering out the record. You can check if the missing POL_PK record is being excluded by this condition by running:

sql
Copy code
SELECT *
FROM ERM.T_ESS_SMOKETEST_POLICIES
WHERE STATE_CD = (SELECT STATE_CD FROM T_POL_DIM_HST WHERE POL_PK = '<MISSING_POL_PK>')
  AND POL_NUM = (SELECT POL_NUM FROM T_POL_DIM_HST WHERE POL_PK = '<MISSING_POL_PK>');
If this query returns results, it means that the NOT EXISTS condition is excluding the record.

4. Check for Null Values in Key Fields:
If any key fields used in joins or conditions (e.g., POL_PK, POL_NUM, STATE_CD) have null values in your data, this could also prevent the record from appearing in the final result. Null values do not participate in joins, so ensure there are no nulls in the critical fields for the missing record.

Run the following query to check for null values in key fields for the missing POL_PK:

sql
Copy code
SELECT POL_PK, POL_NUM, STATE_CD
FROM T_POL_DIM_HST
WHERE POL_PK = '<MISSING_POL_PK>'
AND (POL_NUM IS NULL OR STATE_CD IS NULL);
If you find null values, you'll need to correct them in the source data or handle them explicitly in your query using COALESCE or similar techniques.

5. Validate Data Load Process:
If you are pulling data from an external source (e.g., ETL process or staging tables), ensure that the record is loaded correctly into all the relevant tables. There might be an issue during data extraction or loading that is causing the record to be omitted.

Summary of Steps:
--Informatica Object Names 
--Workflow Name: WFL_NJ_DMV_MONTHLY_EXTRACT 
--Mapping Name: M_S15_NJ_DMV_ALL_EXTRACT 
--Folder: BURRPT_NJ_DMV 
--Session: s_M_S15_NJ_DMV_EXTRACT 
--File Name: WFL_NJ_DMV_MONTHLY_EXTRACT.xml 
 
 
{{  
config(
schema = 'Add your schema here',
--alias = ['S10_NJ_DMV_MTHLY_EXTRACT'],
--scenario = 'update',
materialized = 'incremental',
incremental_strategy = 'merge',
unique_key = ['NJ_DMV_UMIS_MTH_BUILD_ID'],
merge_cols = ['DMV_MAKE_OF_CAR'],
source_pre_sql =[''],
source_post_sql=[''],
target_pre_sql =[],
target_post_sql =[],
table_prefix =[]
)
}}

--parameters are not available for this mapping

SQ_S10_NJ_DMV_MTHLY_EXTRACT as (
        -- writting query for Source_qualifier function
SELECT row_number() over (order by NJ_DMV_UMIS_MTH_BUILD_ID) AS source_record_id,
               S10_NJ_DMV_MTHLY_EXTRACT.NJ_DMV_UMIS_MTH_BUILD_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_PK,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_NUM,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_SEQ_NUM,
               S10_NJ_DMV_MTHLY_EXTRACT.ORIG_POL_PK,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_VRSN,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_EFF_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.ACCTG_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_STATE_STAT,
               S10_NJ_DMV_MTHLY_EXTRACT.ROW_XPTN_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.POL_VRSN_TXN_TYP,
               S10_NJ_DMV_MTHLY_EXTRACT.ROW_STAT,
               S10_NJ_DMV_MTHLY_EXTRACT.RCD_ACTN_TYP_POL,
               S10_NJ_DMV_MTHLY_EXTRACT.DATA_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.CORP_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.CO_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_PROD_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_POL_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.CO_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.PROD_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_CORP_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_CO_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.PRCSG_GRP_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.PROD_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_EFF_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.CUR_TERM_XPTN_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.CNCL_RSN,
               S10_NJ_DMV_MTHLY_EXTRACT.CNCL_TYP,
               S10_NJ_DMV_MTHLY_EXTRACT.CNCL_EFF_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.REINST_TYP,
               S10_NJ_DMV_MTHLY_EXTRACT.REINST_EFF_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.REINST_RSN,
               S10_NJ_DMV_MTHLY_EXTRACT.LAPSE_BEGIN_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.LAPSE_END_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.PLN_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANS_TYPE,
               S10_NJ_DMV_MTHLY_EXTRACT.VEH_UNIT_PK,
               S10_NJ_DMV_MTHLY_EXTRACT.RCD_ACTN_TYP_VEH,
               S10_NJ_DMV_MTHLY_EXTRACT.ORGL_EFF_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.VEH_TYP_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.VIN,
               S10_NJ_DMV_MTHLY_EXTRACT.MODEL_YR,
               S10_NJ_DMV_MTHLY_EXTRACT.MK,
               S10_NJ_DMV_MTHLY_EXTRACT.STAT_MAKE_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.ADDR_PK,
               S10_NJ_DMV_MTHLY_EXTRACT.PMRY_ADDR_FLG,
               S10_NJ_DMV_MTHLY_EXTRACT.HSE_NUM,
               S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS1,
               S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS2,
               S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS3,
               S10_NJ_DMV_MTHLY_EXTRACT.ADDRESS4,
               S10_NJ_DMV_MTHLY_EXTRACT.CITY,
               S10_NJ_DMV_MTHLY_EXTRACT.STATE,
               S10_NJ_DMV_MTHLY_EXTRACT.CNTY,
               S10_NJ_DMV_MTHLY_EXTRACT.PSTL_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.ZIP_FIRST5_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.ZIP_LAST4_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.INSD_PTY_PK_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_PTY_ID_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_FST_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_LST_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_MDL_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_SFX_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.BUS_NAM_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.PMRY_NAMD_INSD_FLG_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.NAMD_INSD_FLG_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_FLG_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_NUM_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_STATE_POL_OWNER,
               S10_NJ_DMV_MTHLY_EXTRACT.ASSOCN_TYP_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.INSD_PTY_PK_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.SRC_PTY_ID_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_FST_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_LST_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_MDL__PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.NAM_SFX_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.NAMD_INSD_FLG_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_FLG_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_NUM_PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.DRVR_LIC_STATE__PRMRY_DRVR,
               S10_NJ_DMV_MTHLY_EXTRACT.BATCH_ID,
               S10_NJ_DMV_MTHLY_EXTRACT.CREATE_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.CREATED_BY,
               S10_NJ_DMV_MTHLY_EXTRACT.BATCH_START_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.BATCH_END_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.RPRTG_PERIOD_START_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.RPRTG_PERIOD_END_DT,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_VIN,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_DRIVER_LICENSE_NUMBER,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_MAKE_OF_CAR,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_YEAR_OF_CAR,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_MODEL_OF_CAR,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_INS_COMPANY_CD,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_STREET_ADDR,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_CITY,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_STATE,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_OWNER_ZIP_CODE,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_TRANSACTION_TYPE_CODE,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_EFFECTIVE_DATE,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_CANCELLATION_DATE,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_DATE_STAMP,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_POLICY_NUMBER,
               S10_NJ_DMV_MTHLY_EXTRACT.DMV_RESERVED,
               LKP_VEH_MAK.MK AS lkp_MK,
               LKP_VEH_MAK.STAT_MAKE_CD AS lkp_STAT_MAKE_CD
          FROM S10_NJ_DMV_MTHLY_EXTRACT S10_NJ_DMV_MTHLY_EXTRACT
          left join -- writting query for lookup function
 (
                select MK,
                       STAT_MAKE_CD,
                       VIN,
                       row_number() over(partition by VIN order by VIN) as rn -- Please review the order by columns

                  FROM T_POL_VEH_UNIT_DIM_HST
                 where (STAT_MAKE_CD IS NOT NULL OR MK IS NOT NULL)
                   AND (RTRIM(LTRIM(STAT_MAKE_CD)) <> '' OR RTRIM(LTRIM(MK)) <> '')
                 ORDER BY CASE WHEN STAT_MAKE_CD IS NULL THEN 1
                               ELSE 0
                                END,
                          CASE WHEN MK IS NULL THEN 1
                               ELSE 0
                                END --
qualify rn = 1
               ) LKP_VEH_MAK
            on LKP_VEH_MAK.VIN = S10_NJ_DMV_MTHLY_EXTRACT.VIN
       ) ,
EXPTRANS as (
        -- writting query for expression function
SELECT source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               lkp_MK AS MK_lkp,
               lkp_STAT_MAKE_CD AS STAT_MAKE_CD_lkp,
               IFF(STAT_MAKE_CD_lkp IS NULL or RTRIM(LTRIM(STAT_MAKE_CD_lkp)) = '',UPPER(RPAD(SUBSTR(RTRIM(LTRIM(MK_lkp)),1,5),5,' ')), UPPER(RPAD(SUBSTR(RTRIM(LTRIM(STAT_MAKE_CD_lkp)),1,5),5,' '))) AS DMV_MAKE_OF_CAR_out
          FROM SQ_S10_NJ_DMV_MTHLY_EXTRACT
       ) ,
UPDTRANS as (
        -- writting query for update strategy function
 SELECT EXPTRANS.source_record_id,
               NJ_DMV_UMIS_MTH_BUILD_ID,
               DMV_MAKE_OF_CAR_out,
               MK_lkp,
               STAT_MAKE_CD_lkp
          FROM EXPTRANS
       ) ,

FINAL_SELECT_S10_NJ_DMV_MTHLY_EXTRACT AS(
        -- writing query for target definition
SELECT NJ_DMV_UMIS_MTH_BUILD_ID :: INTEGER AS NJ_DMV_UMIS_MTH_BUILD_ID,
               trim(DMV_MAKE_OF_CAR_out) :: varchar(5) AS DMV_MAKE_OF_CAR
          FROM UPDTRANS
       ) SELECT *
  FROM FINAL_SELECT_S10_NJ_DMV_MTHLY_EXTRACT;
