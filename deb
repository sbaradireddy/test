SELECT SQ_nj_dmv_mthly_generic_ff.DMV_INS_COMPANY_CD,
       LKP_VERSION_NUMBER.DMV_INS_COMPANY_CD AS lkp_DMV_INS_COMPANY_CD,
       LKP_VERSION_NUMBER.DMV_ORIG_CYCLE_DUE_DATE,
       LKP_VERSION_NUMBER.ROW_ORIGIN,
       LKP_VERSION_NUMBER.VERSION_NBR
FROM RDMDEV.RRM.nj_dmv_mthly_submission_dw SQ_nj_dmv_mthly_generic_ff
LEFT JOIN (
    select DMV_INS_COMPANY_CD,
           DMV_ORIG_CYCLE_DUE_DATE,
           ROW_ORIGIN,
           VERSION_NBR,
           row_number() over(partition by DMV_INS_COMPANY_CD, DMV_ORIG_CYCLE_DUE_DATE, ROW_ORIGIN
                             order by DMV_INS_COMPANY_CD, DMV_ORIG_CYCLE_DUE_DATE, ROW_ORIGIN DESC) as rn 
    from RDMDEV.BURRPT.nj_dmv_mthly_merge_header_dw
    qualify rn = 1
) LKP_VERSION_NUMBER
ON LKP_VERSION_NUMBER.DMV_INS_COMPANY_CD = SQ_nj_dmv_mthly_generic_ff.DMV_INS_COMPANY_CD
AND LKP_VERSION_NUMBER.DMV_ORIG_CYCLE_DUE_DATE = TO_CHAR(SYSDATE(), 'MMDDYYYY')
AND LKP_VERSION_NUMBER.ROW_ORIGIN = 'W'
