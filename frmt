
WITH SQ_S10_MA_DMV_EXTRACT AS (
    SELECT T_POL_DIM_HST.POL_PK 
    FROM DWADMN.T_POL_PTY_DIM_HST T_POL_PTY_DIM_HST, 
         DWADMN.V_POL_DIM_HST_CORE T_POL_DIM_HST,  
         DWADMN.V_POL_VEH_UNIT_DIM_HST_CORE T_POL_VEH_UNIT_DIM_HST, 
         DWADMN.T_CO_DIM T_CO_DIM,  
         DWADMN.T_POL_ADDR_DIM_HST T_POL_ADDR_DIM_HST,
         DWADMN.T_POL_STAT_TRANS_HST T_POL_STAT_TRANS_HST,  
         DWADMN.T_POL_CVG_FACT T_POL_CVG_FACT 
    WHERE T_POL_DIM_HST.CO_CD IN ('ALN_PRAC', 'ALN_PIC', 'PMC', 'PRAC')
      AND (
          (T_POL_DIM_HST.PROD_CD IN ('PA') 
           AND T_POL_VEH_UNIT_DIM_HST.VEH_TYP_CD IN ('AQ', 'CL', 'MC', 'MH', 'PPA'))
          OR
          (T_POL_DIM_HST.PROD_CD IN ('CA') 
           AND T_POL_VEH_UNIT_DIM_HST.VEH_TYP_CD IN ('PP', 'STV', 'TR', 'TR_TRAC', 'VAN'))
      )
      AND T_POL_DIM_HST.STATE_CD = 'CT'  
      AND T_POL_DIM_HST.RCD_ACTN_TYP <> 'D' 
      AND (
          T_POL_STAT_TRANS_HST.POL_STAT_PK IN (
              SELECT MAX(AL5.POL_STAT_PK)
              FROM DWADMN.V_POL_STAT_TRANS_HST AL5
              WHERE AL5.DATA_DT <= '09/30/2024' 
                AND AL5.POL_PK = T_POL_STAT_TRANS_HST.POL_PK
          )
          AND T_POL_STAT_TRANS_HST.POL_STAT = 'ACTIVE'
          AND T_POL_STAT_TRANS_HST.POL_STATE_EFF_DT <= '09-30-2024' 
          AND T_POL_STAT_TRANS_HST.ROW_XPTN_DT > '09/30/2024' 
          AND T_POL_CVG_FACT.CNTRBT_TO_PRMM_FLG = 'Y'
          AND (NOT T_POL_CVG_FACT.RCD_ACTN_TYP = 'D')
      )
      AND T_POL_ADDR_DIM_HST.PMRY_ADDR_FLG = 'Y'
      AND T_POL_PTY_DIM_HST.NAMD_INSD_FLG = 'Y' 
      AND T_POL_VEH_UNIT_DIM_HST.POL_STATE_STAT = 'ACTIVE'  
      AND T_POL_VEH_UNIT_DIM_HST.RCD_ACTN_TYP <> 'D' 
      AND T_POL_DIM_HST.POL_PK = T_POL_PTY_DIM_HST.POL_PK 
      AND T_POL_VEH_UNIT_DIM_HST.POL_PK = T_POL_DIM_HST.POL_PK 
      AND T_CO_DIM.CO_ID = T_POL_DIM_HST.CO_ID
      AND T_POL_DIM_HST.POL_PK = T_POL_ADDR_DIM_HST.POL_PK 
      AND T_POL_STAT_TRANS_HST.POL_PK = T_POL_DIM_HST.POL_PK 
      AND T_POL_CVG_FACT.POL_PK = T_POL_DIM_HST.POL_PK
), 
SQ_S10_MA_DMV_EXTRACT_TEMP AS (
    -- Query for source qualifier function
    SELECT row_number() OVER (ORDER BY POL_PK) AS source_record_id,
           POL_PK
    FROM SQ_S10_MA_DMV_EXTRACT
), 
EXPTRANS AS (
    -- Query for expression function
    SELECT SQ_S10_MA_DMV_EXTRACT.source_record_id,
           SQ_S10_MA_DMV_EXTRACT.POL_PK,
           LKP_PRIOR_VERSN_POL_PK.ORIG_POL_PK
    FROM SQ_S10_MA_DMV_EXTRACT
    LEFT JOIN (
        -- Query for lookup function
        SELECT ORIG_POL_PK,
               POL_PK,
               row_number() OVER (PARTITION BY POL_PK ORDER BY POL_PK) AS rn
        FROM DWADMN.T_POL_STAT_DIM_HST
        WHERE LTRIM(RTRIM(DWADMN.T_POL_STAT_DIM_HST.STAT_TRAN_CODE)) = 'CREDIT'
    ) LKP_PRIOR_VERSN_POL_PK
    ON LKP_PRIOR_VERSN_POL_PK.POL_PK = SQ_S10_MA_DMV_EXTRACT.POL_PK
    WHERE rn = 1
), 
UNIONTRANS AS (
    -- Renaming the "UNION" CTE to "UNIONTRANS"
    SELECT source_record_id, POL_PK AS POL_PK
    FROM EXPTRANS
    UNION
    SELECT source_record_id, ORIG_POL_PK AS POL_PK
    FROM EXPTRANS
), 
AGGTRANS AS (
    -- Query for Aggregator function
    SELECT DISTINCT source_record_id, POL_PK
    FROM UNIONTRANS
),
FINAL_SELECT_CT_DMV_POLICY_LIST AS (
    -- Writing query for target definition
    SELECT POL_PK :: INTEGER AS POL_PK
    FROM AGGTRANS
)
SELECT *
FROM FINAL_SELECT_CT_DMV_POLICY_LIST;