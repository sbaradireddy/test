with SQ_S10_MA_DMV_EXTRACT as (
SELECT T_POL_DIM_HST.POL_PK 
FROM
DWADMN.T_POL_PTY_DIM_HST T_POL_PTY_DIM_HST, 
DWADMN.V_POL_DIM_HST_CORE T_POL_DIM_HST,  
DWADMN.V_POL_VEH_UNIT_DIM_HST_CORE T_POL_VEH_UNIT_DIM_HST, 
DWADMN.T_CO_DIM T_CO_DIM,  
DWADMN.T_POL_ADDR_DIM_HST T_POL_ADDR_DIM_HST,
DWADMN.T_POL_STAT_TRANS_HST T_POL_STAT_TRANS_HST ,  
DWADMN.T_POL_CVG_FACT T_POL_CVG_FACT 
WHERE
 T_Pol_Dim_Hst.CO_CD  IN ('ALN_PRAC', 'ALN_PIC','PMC','PRAC') and
( 
(T_Pol_Dim_Hst.PROD_CD IN ('PA') and
T_Pol_VEH_UNIT_DIM_HST.VEH_TYP_CD IN ('AQ','CL','MC','MH','PPA')  )
 OR
(T_Pol_Dim_Hst.PROD_CD IN ('CA') and
T_Pol_VEH_UNIT_DIM_HST.VEH_TYP_CD IN ('PP','STV','TR','TR_TRAC','VAN')  )
) and
T_Pol_Dim_Hst.STATE_CD = 'CT'  and
T_Pol_Dim_Hst.RCD_ACTN_TYP <>  'D' and
((T_POL_STAT_TRANS_HST.POL_STAT_PK IN
(SELECT MAX ( AL5.POL_STAT_PK )
FROM DWADMN.V_POL_STAT_TRANS_HST AL5
WHERE ((AL5.DATA_DT<='09/30/2024' AND AL5.POL_PK=T_POL_STAT_TRANS_HST.POL_PK)))
AND T_POL_STAT_TRANS_HST.POL_STAT='ACTIVE'
AND T_POL_STAT_TRANS_HST.POL_STATE_EFF_DT<='09-30-2024' 
AND T_POL_STAT_TRANS_HST.ROW_XPTN_DT>'09/30/2024' 
AND T_POL_CVG_FACT.CNTRBT_TO_PRMM_FLG='Y'
AND (NOT T_POL_CVG_FACT.RCD_ACTN_TYP='D')))
AND
T_Pol_Addr_Dim_Hst.Pmry_Addr_Flg='Y' and
T_POL_PTY_DIM_HST.NAMD_INSD_FLG='Y' AND
T_Pol_VEH_UNIT_DIM_HST.POL_STATE_STAT = 'ACTIVE'  
and
T_Pol_VEH_UNIT_DIM_HST.RCD_ACTN_TYP<>'D' 
AND
 T_POL_DIM_HST.POL_PK=T_POL_PTY_DIM_HST.POL_PK and T_POL_VEH_UNIT_DIM_HST.POL_PK=T_POL_DIM_HST.POL_PK and T_CO_DIM.CO_ID=T_POL_DIM_HST.CO_ID
 and T_POL_DIM_HST.POL_PK=T_POL_ADDR_DIM_HST.POL_PK and
 T_POL_STAT_TRANS_HST.POL_PK=T_POL_DIM_HST.POL_PK and T_POL_CVG_FACT.POL_PK=T_POL_DIM_HST.POL_PK
 ) , 
SQ_S10_MA_DMV_EXTRACT as ( 
 -- writting query for Source_qualifier function 
SELECT row_number() over(order by POL_PK) AS source_record_id,
POL_PK
FROM SQ_S10_MA_DMV_EXTRACT_temp
 ) , 
EXPTRANS as (
        -- writting query for expression function
SELECT SQ_S10_MA_DMV_EXTRACT.source_record_id,
               SQ_S10_MA_DMV_EXTRACT.POL_PK,
               LKP_PRIOR_VERSN_POL_PK.ORIG_POL_PK
          FROM SQ_S10_MA_DMV_EXTRACT SQ_S10_MA_DMV_EXTRACT
          left join -- writting query for lookup function
 (
                select ORIG_POL_PK,
                       POL_PK,
                       row_number() over(partition by POL_PK order by POL_PK) as rn -- Please review the order by columns

                  FROM DWADMN.T_POL_STAT_DIM_HST
                 where LTRIM(RTRIM(DWADMN.T_POL_STAT_DIM_HST.STAT_TRAN_CODE)) = 'CREDIT' qualify rn = 1
               ) LKP_PRIOR_VERSN_POL_PK
            on LKP_PRIOR_VERSN_POL_PK.POL_PK = SQ_S10_MA_DMV_EXTRACT.POL_PK
       ) ,
        UNION as (
        -- writting query for union
      SELECT source_record_id,POL_PK AS POL_PK
            from EXPTRANS
         UNION select source_record_id,
               ORIG_POL_PK AS POL_PK
            from EXPTRANS
       ) ,
          AGGTRANS as (
        -- writting query for Aggregator function
         SELECT DISTINCT source_record_id, POL_PK
         FROM UNION
       ) 

--FINAL_SELECT_CT_DMV_POLICY_LIST AS(
        -- writing query for target definition
SELECT POL_PK :: INTEGER AS POL_PK
          FROM AGGTRANS
       
     
